<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Titlovi.com</title>
</head>

<body>
  <div id="titlovi-config-page" data-role="page" class="page type-interior pluginConfigurationPage"
    data-require="emby-input,emby-button,emby-select,emby-checkbox">
    <div data-role="content">
      <div class="content-primary" style="max-width:45%;">
        <div id="titlovi-config-page">
          <h3>Account</h3>
          <div class="inputContainer">
            <div>
              <label class="inputLabel inputLabelUnfocused" for="titlovi-username">Username</label>
              <input id="titlovi-username" name="titlovi-username" type="text" is="emby-input" />
              <div class="fieldDescription">Username of your account.</div>
            </div>
            <div style="margin-top:5px;">
              <label class="inputLabel inputLabelUnfocused" for="titlovi-password">Password</label>
              <input id="titlovi-password" name="titlovi-password" type="password" is="emby-input" />
              <div class="fieldDescription">Password of your account.</div>
            </div>
            <div style="margin-top:5px;">
              <button id="titlovi-token-authenticate" is="emby-button" type="button"
                class="raised button-submit block emby-button">
                <span>Authenticate</span>
              </button>
            </div>
          </div>
        </div>
        <div class="content-secondary">
          <label class="inputLabel inputLabelUnfocused" for="titlovi-token">Token</label>
          <input id="titlovi-token" name="titlovi-token" type="password" is="emby-input" disabled />
          <div class="fieldDescription">You token expires at: <span id="titlovi-token-date"></span></div>
          <div style="margin-top:5px;">
            <button id="titlovi-token-invalidate" is="emby-button" type="button" class="raised block emby-button"
              style="background-color: #dc3545 !important; border-color: #dc3545 !important; color: white !important;">
              <span>Invalidate Token</span>
            </button>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
      var TitloviConfig = {pluginUniqueId: "6e25df50-638e-4109-a50b-03c14fc93fdd"};

      document.querySelector('#titlovi-config-page').addEventListener('pageshow', function () {
        Dashboard.showLoadingMsg();
        ApiClient.getPluginConfiguration(TitloviConfig.pluginUniqueId).then(function (config) {
          document.querySelector('#titlovi-username').value = config.LoginInfo.username;
          document.querySelector('#titlovi-password').value = config.LoginInfo.password;

          if (config.TokenInfo) {
            document.querySelector('#titlovi-token').value = config.TokenInfo.Token;
            document.querySelector('#titlovi-token-date').textContent = config.TokenInfo.ExpirationDate;
          }
          Dashboard.hideLoadingMsg();
        });
      });

      document.querySelector('#titlovi-token-invalidate').addEventListener('click', function () {
        fetch(ApiClient.getUrl('Titlovi/InvalidateToken'), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Emby-Token': ApiClient.accessToken()
          }
        }).then(response => {
          if (response.ok) {
            document.querySelector('#titlovi-token').value = "";
            document.querySelector('#titlovi-token-date').textContent = "";

            Dashboard.alert({message: "Token successfully invalidated.", title: "Success"});
          } else {
            Dashboard.alert({message: "Failed to invalidate token!", title: "Error"});
          }
        }).catch(error => Dashboard.alert({message: "Failed to call the internal API.", title: "Error"}));
        e.preventDefault();
      });

      document.querySelector('#titlovi-token-authenticate').addEventListener('click', function (e) {
        ApiClient.getPluginConfiguration(TitloviConfig.pluginUniqueId).then(function (config) {
          config.LoginInfo.username = document.querySelector('#titlovi-username').value;
          config.LoginInfo.password = document.querySelector('#titlovi-password').value;
          ApiClient.updatePluginConfiguration(TitloviConfig.pluginUniqueId, config).then(function (result) {
            Dashboard.processPluginConfigurationUpdateResult(result);
          }).then(function (result) {
            fetch(ApiClient.getUrl('Titlovi/Authenticate'), {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-Emby-Token': ApiClient.accessToken()
              }
            }).then(response => {
              if (response.ok) {
                Dashboard.alert({message: "You have been successfully authenciated!", title: "Success"});
              } else {
                Dashboard.alert({message: "Authentication has failed, please check your credentials and try again!", title: "Error"});
              }
            }).catch(error => Dashboard.alert({message: "Failed to call the internal API.", title: "Error"}));
          });
        });
        e.preventDefault();
      });
    </script>
  </div>
</body>

</html>
